name: Build Finix Player for Linux

on:
  push:
    branches: 
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  QT_VERSION: '6.10.0'
  CMAKE_BUILD_TYPE: Release
  BUILD_DIR: build
  ARTIFACT_NAME: FinixPlayer-Linux
  QT_ROOT: /home/runner/Qt/6.10.0/gcc_64

jobs:
  build-linux:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Clean Build Directory
        run: |
          if [ -d "${{ env.BUILD_DIR }}" ]; then
            echo "Removing existing build directory..."
            rm -rf ${{ env.BUILD_DIR }}
          fi
          echo "Creating fresh build directory..."
          mkdir -p ${{ env.BUILD_DIR }}

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xkb1 \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libpulse-dev \
            libasound2-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-good1.0-dev \
            libgstreamer-plugins-bad1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav \
            gstreamer1.0-tools \
            gstreamer1.0-x \
            gstreamer1.0-alsa \
            gstreamer1.0-gl \
            gstreamer1.0-gtk3 \
            gstreamer1.0-qt5 \
            gstreamer1.0-pulseaudio \
            libfuse2 \
            file \
            wget \
            curl \
            imagemagick

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install aqtinstall
        run: |
          python -m pip install --upgrade pip
          pip install aqtinstall

      - name: Install Qt Base
        run: |
          aqt install-qt linux desktop ${{ env.QT_VERSION }} gcc_64 -O $HOME/Qt

      - name: Install Qt Multimedia Module
        run: |
          aqt install-qt linux desktop ${{ env.QT_VERSION }} gcc_64 -m qtmultimedia -O $HOME/Qt
        continue-on-error: true

      - name: Install Qt 5 Compat Module
        run: |
          aqt install-qt linux desktop ${{ env.QT_VERSION }} gcc_64 -m qt5compat -O $HOME/Qt
        continue-on-error: true

      - name: Install Qt Shader Tools Module
        run: |
          aqt install-qt linux desktop ${{ env.QT_VERSION }} gcc_64 -m qtshadertools -O $HOME/Qt
        continue-on-error: true

      - name: Set Qt Environment Variables
        run: |
          echo "${{ env.QT_ROOT }}/bin" >> $GITHUB_PATH
          echo "CMAKE_PREFIX_PATH=${{ env.QT_ROOT }}" >> $GITHUB_ENV
          echo "Qt6_DIR=${{ env.QT_ROOT }}/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${{ env.QT_ROOT }}/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "QT_PLUGIN_PATH=${{ env.QT_ROOT }}/plugins" >> $GITHUB_ENV
          echo "QML2_IMPORT_PATH=${{ env.QT_ROOT }}/qml" >> $GITHUB_ENV

      - name: Verify Qt Installation
        run: |
          echo "==== Qt Installation Verification ===="
          echo "Qt Root: ${{ env.QT_ROOT }}"
          echo ""
          qmake --version
          echo ""
          echo "GCC version:"
          gcc --version
          echo ""
          echo "CMake version:"
          cmake --version

      - name: Download yt-dlp
        run: |
          echo "Downloading yt-dlp..."
          wget https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -O yt-dlp
          chmod +x yt-dlp
          echo "yt-dlp downloaded successfully"
        continue-on-error: true

      - name: Configure CMake
        run: |
          cmake -S . -B ${{ env.BUILD_DIR }} \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="${{ env.QT_ROOT }}" \
            -DQt6_DIR="${{ env.QT_ROOT }}/lib/cmake/Qt6" \
            -DCMAKE_VERBOSE_MAKEFILE=ON

      - name: Build Project
        run: |
          cmake --build ${{ env.BUILD_DIR }} --config ${{ env.CMAKE_BUILD_TYPE }} --parallel $(nproc)

      - name: Verify Build Output
        run: |
          echo "Checking build output..."
          ls -lh ${{ env.BUILD_DIR }}/
          if [ -f "${{ env.BUILD_DIR }}/FinixPlayer" ]; then
            echo "✓ FinixPlayer executable found"
            file ${{ env.BUILD_DIR }}/FinixPlayer
          else
            echo "✗ FinixPlayer executable not found!"
            exit 1
          fi

      - name: Download linuxdeployqt
        run: |
          wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
          chmod +x linuxdeployqt-continuous-x86_64.AppImage

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          cp ${{ env.BUILD_DIR }}/FinixPlayer AppDir/usr/bin/
          
          if [ -f "yt-dlp" ]; then
            cp yt-dlp AppDir/usr/bin/
          fi
          
          echo "[Desktop Entry]" > AppDir/usr/share/applications/FinixPlayer.desktop
          echo "Type=Application" >> AppDir/usr/share/applications/FinixPlayer.desktop
          echo "Name=Finix Player" >> AppDir/usr/share/applications/FinixPlayer.desktop
          echo "Comment=Modern Audio Player with Effects" >> AppDir/usr/share/applications/FinixPlayer.desktop
          echo "Exec=FinixPlayer" >> AppDir/usr/share/applications/FinixPlayer.desktop
          echo "Icon=FinixPlayer" >> AppDir/usr/share/applications/FinixPlayer.desktop
          echo "Categories=AudioVideo;Audio;Player;Qt;" >> AppDir/usr/share/applications/FinixPlayer.desktop
          echo "Terminal=false" >> AppDir/usr/share/applications/FinixPlayer.desktop
          
          if [ -f "assests/app_icon_full.png" ]; then
            cp assests/app_icon_full.png AppDir/usr/share/icons/hicolor/256x256/apps/FinixPlayer.png
          else
            convert -size 256x256 xc:"#3D5AFE" -pointsize 72 -fill white -gravity center \
              -font DejaVu-Sans-Bold -annotate +0+0 "FP" \
              AppDir/usr/share/icons/hicolor/256x256/apps/FinixPlayer.png 2>/dev/null || \
              touch AppDir/usr/share/icons/hicolor/256x256/apps/FinixPlayer.png
          fi

      - name: Deploy Qt Dependencies
        run: |
          export LD_LIBRARY_PATH=${{ env.QT_ROOT }}/lib:$LD_LIBRARY_PATH
          export PATH=${{ env.QT_ROOT }}/bin:$PATH
          
          ./linuxdeployqt-continuous-x86_64.AppImage AppDir/usr/share/applications/FinixPlayer.desktop \
            -appimage \
            -bundle-non-qt-libs \
            -qmldir=. \
            -verbose=2 || echo "linuxdeployqt completed with warnings"
          
          if [ -f Finix_Player*.AppImage ]; then
            mv Finix_Player*.AppImage FinixPlayer-x86_64.AppImage
          fi

      - name: Create Portable Package
        run: |
          mkdir -p FinixPlayer-Portable
          
          cp ${{ env.BUILD_DIR }}/FinixPlayer FinixPlayer-Portable/
          
          cp -r ${{ env.QT_ROOT }}/lib/*.so* FinixPlayer-Portable/ 2>/dev/null || true
          cp -r ${{ env.QT_ROOT }}/plugins FinixPlayer-Portable/ 2>/dev/null || true
          cp -r ${{ env.QT_ROOT }}/qml FinixPlayer-Portable/ 2>/dev/null || true
          
          if [ -f "yt-dlp" ]; then
            cp yt-dlp FinixPlayer-Portable/
          fi
          
          if [ -f "README.md" ]; then
            cp README.md FinixPlayer-Portable/
          fi
          
          if [ -f "LICENSE" ]; then
            cp LICENSE FinixPlayer-Portable/
          fi
          
          cat > FinixPlayer-Portable/run.sh << 'RUNSCRIPT'
          #!/bin/bash
          SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          export LD_LIBRARY_PATH="$SCRIPT_DIR:$LD_LIBRARY_PATH"
          export QT_PLUGIN_PATH="$SCRIPT_DIR/plugins"
          export QML2_IMPORT_PATH="$SCRIPT_DIR/qml"
          cd "$SCRIPT_DIR"
          ./FinixPlayer "$@"
          RUNSCRIPT
          
          chmod +x FinixPlayer-Portable/run.sh
          
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          cat > FinixPlayer-Portable/BUILD_INFO.txt << BUILDINFO
          Finix Player - Linux Build
          ==========================
          Build Date: ${BUILD_DATE}
          Qt Version: ${{ env.QT_VERSION }}
          Build Type: ${{ env.CMAKE_BUILD_TYPE }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          
          System Requirements:
          - Ubuntu 20.04 or later (or equivalent)
          - GStreamer multimedia framework
          - X11 or Wayland display server
          
          How to Run:
          1. Extract all files to a folder
          2. Run: ./run.sh
          3. Or use the AppImage (if available)
          
          For AppImage:
          - Make it executable: chmod +x FinixPlayer-x86_64.AppImage
          - Run: ./FinixPlayer-x86_64.AppImage
          BUILDINFO
          
          tar -czf FinixPlayer-Linux-Portable.tar.gz FinixPlayer-Portable/
          
          echo "Package created successfully"
          ls -lh FinixPlayer-Linux-Portable.tar.gz
          if [ -f FinixPlayer-x86_64.AppImage ]; then
            ls -lh FinixPlayer-x86_64.AppImage
          fi

      - name: Upload AppImage
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-AppImage-${{ github.run_number }}
          path: FinixPlayer-x86_64.AppImage
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Portable Package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-Portable-${{ github.run_number }}
          path: FinixPlayer-Linux-Portable.tar.gz
          retention-days: 30

      - name: Display Build Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "          BUILD SUCCESSFUL"
          echo "=========================================="
          echo "Project: Finix Player"
          echo "Platform: Linux (Ubuntu)"
          echo "Qt Version: ${{ env.QT_VERSION }}"
          echo "Build Type: ${{ env.CMAKE_BUILD_TYPE }}"
          echo "Commit: ${{ github.sha }}"
          echo "=========================================="
          
          if [ -f "${{ env.BUILD_DIR }}/FinixPlayer" ]; then
            exe_size=$(du -h "${{ env.BUILD_DIR }}/FinixPlayer" | cut -f1)
            echo "Executable Size: $exe_size"
          fi
          
          if [ -f "FinixPlayer-Linux-Portable.tar.gz" ]; then
            tar_size=$(du -h "FinixPlayer-Linux-Portable.tar.gz" | cut -f1)
            echo "Portable Package Size: $tar_size"
          fi
          
          if [ -f "FinixPlayer-x86_64.AppImage" ]; then
            appimage_size=$(du -h "FinixPlayer-x86_64.AppImage" | cut -f1)
            echo "AppImage Size: $appimage_size"
          fi
          echo "=========================================="

      - name: Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-linux-${{ github.run_number }}
          path: |
            ${{ env.BUILD_DIR }}/CMakeFiles/*.log
            ${{ env.BUILD_DIR }}/**/*.log
          retention-days: 7
          if-no-files-found: ignore

name: Build Windows (Simple & Reliable)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Windows Build
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install MinGW
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64
          version: 12.2.0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.10.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          modules: 'qtmultimedia qtshadertools qt5compat'
          cache: false  # Disable cache to ensure Qt 6.10 is installed

      - name: Verify Setup
        shell: pwsh
        run: |
          Write-Host "=== Verifying Installation ==="
          Write-Host "GCC Version:"
          gcc --version
          Write-Host "`nG++ Version:"
          g++ --version
          Write-Host "`nMake Version:"
          mingw32-make --version
          Write-Host "`nQt6_DIR: $env:Qt6_DIR"
          Write-Host "`nPATH: $env:PATH"

      - name: Download yt-dlp
        shell: pwsh
        run: |
          Write-Host "Downloading yt-dlp..."
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "yt-dlp.exe"
          Write-Host "✓ Downloaded yt-dlp.exe"

      - name: Configure with CMake
        shell: pwsh
        run: |
          mkdir build
          cd build
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$env:Qt6_DIR"

      - name: Build
        shell: pwsh
        run: |
          cd build
          mingw32-make -j$env:NUMBER_OF_PROCESSORS

      - name: Deploy Qt Dependencies
        shell: pwsh
        run: |
          cd build
          & "${env:Qt6_DIR}/../../../bin/windeployqt.exe" --qmldir .. --release FinixPlayer.exe

      - name: Package Release
        shell: pwsh
        run: |
          $dist = "FinixPlayer-Windows"
          New-Item -ItemType Directory -Path $dist
          
          # Copy executable and yt-dlp
          Copy-Item build/FinixPlayer.exe $dist/
          Copy-Item yt-dlp.exe $dist/
          
          # Copy all DLLs
          Copy-Item build/*.dll $dist/ -ErrorAction SilentlyContinue
          
          # Copy Qt directories
          Copy-Item build/plugins $dist/ -Recurse -ErrorAction SilentlyContinue
          Copy-Item build/qml $dist/ -Recurse -ErrorAction SilentlyContinue
          
          # Copy docs
          Copy-Item README.md $dist/ -ErrorAction SilentlyContinue
          Copy-Item LICENSE $dist/ -ErrorAction SilentlyContinue
          
          # Copy assets
          Copy-Item assests $dist/ -Recurse -ErrorAction SilentlyContinue
          
          # Create ZIP
          Compress-Archive -Path $dist -DestinationPath "${dist}.zip"
          
          Write-Host "✓ Package created: ${dist}.zip"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FinixPlayer-Windows
          path: FinixPlayer-Windows.zip

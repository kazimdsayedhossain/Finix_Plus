name: Build Windows (Qt Compatible MinGW)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Windows Build
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # DO NOT install separate MinGW - use Qt's bundled version
      - name: Install Qt with MinGW
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          modules: 'qtmultimedia qtshadertools qt5compat'
          cache: true

      - name: Setup Qt's MinGW Compiler
        shell: pwsh
        run: |
          Write-Host "=== Locating Qt's MinGW Compiler ==="
          
          # Qt 6.8.1 uses MinGW 11.2.0
          $qtRoot = Split-Path (Split-Path (Split-Path $env:Qt6_DIR -Parent) -Parent) -Parent
          Write-Host "Qt Root: $qtRoot"
          
          # Search for MinGW in Tools directory
          $mingwCandidates = @(
            "$qtRoot\Tools\mingw1120_64\bin",
            "$qtRoot\Tools\mingw_64\bin",
            "$qtRoot\Tools\mingw90\bin"
          )
          
          $mingwPath = $null
          foreach ($candidate in $mingwCandidates) {
            Write-Host "Checking: $candidate"
            if (Test-Path "$candidate\gcc.exe") {
              $mingwPath = $candidate
              Write-Host "✓ Found MinGW at: $mingwPath"
              break
            }
          }
          
          if (-not $mingwPath) {
            Write-Host "ERROR: Could not find Qt's MinGW compiler!"
            Write-Host "Available Tools directories:"
            Get-ChildItem "$qtRoot\Tools" -Directory | ForEach-Object { Write-Host "  - $($_.Name)" }
            exit 1
          }
          
          # Add to PATH (prepend to ensure it's used first)
          $env:PATH = "$mingwPath;$env:PATH"
          echo "$mingwPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          Write-Host "`n=== MinGW Added to PATH ==="
          Write-Host "MinGW Path: $mingwPath"

      - name: Verify Compiler Setup
        shell: pwsh
        run: |
          Write-Host "=== Verifying Compiler Setup ==="
          
          Write-Host "`nGCC Location:"
          $gccPath = (Get-Command gcc).Source
          Write-Host $gccPath
          
          Write-Host "`nGCC Version:"
          gcc --version
          
          Write-Host "`nG++ Version:"
          g++ --version
          
          Write-Host "`nMake Version:"
          mingw32-make --version
          
          Write-Host "`nQt CMake Directory:"
          Write-Host $env:Qt6_DIR
          
          # Verify we're NOT using Chocolatey's MinGW
          if ($gccPath -like "*chocolatey*") {
            Write-Host "`nWARNING: Using Chocolatey's MinGW instead of Qt's!"
            Write-Host "This will cause compilation errors."
            exit 1
          } else {
            Write-Host "`n✓ Using Qt's MinGW compiler (correct)"
          }

      - name: Download yt-dlp
        shell: pwsh
        run: |
          Write-Host "Downloading yt-dlp..."
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "yt-dlp.exe"
          if (Test-Path "yt-dlp.exe") {
            Write-Host "✓ Downloaded yt-dlp.exe ($((Get-Item yt-dlp.exe).Length) bytes)"
          } else {
            Write-Host "ERROR: Failed to download yt-dlp.exe"
            exit 1
          }

      - name: Configure with CMake
        shell: pwsh
        run: |
          Write-Host "=== Configuring Project with CMake ==="
          New-Item -ItemType Directory -Path "build" -Force | Out-Null
          cd build
          
          cmake .. `
            -G "MinGW Makefiles" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: CMake configuration failed"
            exit 1
          }
          Write-Host "✓ CMake configuration successful"

      - name: Build Project
        shell: pwsh
        run: |
          Write-Host "=== Building Project ==="
          cd build
          
          $cores = $env:NUMBER_OF_PROCESSORS
          if (-not $cores) { $cores = 2 }
          Write-Host "Building with $cores parallel jobs..."
          
          mingw32-make -j $cores
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Build failed"
            exit 1
          }
          
          if (Test-Path "FinixPlayer.exe") {
            $exeSize = (Get-Item "FinixPlayer.exe").Length
            Write-Host "✓ Build successful - FinixPlayer.exe ($exeSize bytes)"
          } else {
            Write-Host "ERROR: FinixPlayer.exe was not created"
            exit 1
          }

      - name: Deploy Qt Dependencies
        shell: pwsh
        run: |
          Write-Host "=== Deploying Qt Dependencies ==="
          cd build
          
          $windeployqt = "$env:Qt6_DIR/../../../bin/windeployqt.exe"
          if (-not (Test-Path $windeployqt)) {
            Write-Host "ERROR: windeployqt.exe not found at $windeployqt"
            exit 1
          }
          
          Write-Host "Running windeployqt..."
          & $windeployqt --qmldir .. --release FinixPlayer.exe
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "WARNING: windeployqt reported errors, but continuing..."
          }
          Write-Host "✓ Qt dependencies deployed"

      - name: Package Release
        shell: pwsh
        run: |
          Write-Host "=== Packaging Release ==="
          
          $dist = "FinixPlayer-Windows"
          New-Item -ItemType Directory -Path $dist -Force | Out-Null
          
          # Copy executable
          Copy-Item "build/FinixPlayer.exe" "$dist/" -Force
          Write-Host "✓ Copied FinixPlayer.exe"
          
          # Copy yt-dlp
          Copy-Item "yt-dlp.exe" "$dist/" -Force
          Write-Host "✓ Copied yt-dlp.exe"
          
          # Copy DLLs
          Get-ChildItem "build/*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "$dist/" -Force
          }
          Write-Host "✓ Copied DLL files"
          
          # Copy Qt plugin directories
          if (Test-Path "build/plugins") {
            Copy-Item "build/plugins" "$dist/" -Recurse -Force
            Write-Host "✓ Copied plugins directory"
          }
          
          if (Test-Path "build/qml") {
            Copy-Item "build/qml" "$dist/" -Recurse -Force
            Write-Host "✓ Copied qml directory"
          }
          
          # Copy documentation
          if (Test-Path "README.md") {
            Copy-Item "README.md" "$dist/" -Force
            Write-Host "✓ Copied README.md"
          }
          
          if (Test-Path "LICENSE") {
            Copy-Item "LICENSE" "$dist/" -Force
            Write-Host "✓ Copied LICENSE"
          }
          
          # Copy assets
          if (Test-Path "assests") {
            Copy-Item "assests" "$dist/" -Recurse -Force
            Write-Host "✓ Copied assets directory"
          }
          
          # Create ZIP archive
          Compress-Archive -Path $dist -DestinationPath "${dist}.zip" -Force
          
          $zipSize = (Get-Item "${dist}.zip").Length / 1MB
          Write-Host "`n✓ Package created: ${dist}.zip ($([math]::Round($zipSize, 2)) MB)"
          
          # List contents
          Write-Host "`nPackage contents:"
          Get-ChildItem $dist -Recurse -File | ForEach-Object {
            Write-Host "  - $($_.FullName.Replace("$dist\", ""))"
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FinixPlayer-Windows
          path: FinixPlayer-Windows.zip
          if-no-files-found: error

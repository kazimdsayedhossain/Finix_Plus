name: Build Windows Release (Optimized)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release'
        required: false
        default: 'false'

jobs:
  build-windows-mingw:
    name: Windows MinGW Build
    runs-on: windows-latest

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup MinGW 13
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 13
          platform: x64

      - name: Install Qt 6.8.1
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.1'
          arch: 'win64_mingw'
          modules: 'qtmultimedia qtshadertools'
          cache: true
          cache-key-prefix: 'qt-6.8.1-mingw'
          setup-python: false

      - name: Download yt-dlp
        run: |
          Write-Host "Downloading yt-dlp..."
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "yt-dlp.exe"
          if (Test-Path "yt-dlp.exe") {
            Write-Host "âœ“ yt-dlp.exe downloaded successfully"
            $size = (Get-Item "yt-dlp.exe").Length / 1MB
            Write-Host "File size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "Failed to download yt-dlp.exe"
            exit 1
          }

      - name: Configure CMake
        run: |
          Write-Host "Cleaning build directory..."
          if (Test-Path build) { 
            Remove-Item -Recurse -Force build 
          }
          
          Write-Host "Creating build directory..."
          New-Item -ItemType Directory -Name build | Out-Null
          
          cd build
          
          Write-Host "Configuring CMake..."
          cmake .. -G "MinGW Makefiles" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" `
            -DCMAKE_C_COMPILER=gcc `
            -DCMAKE_CXX_COMPILER=g++
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "CMake configuration failed"
            exit 1
          }
          
          Write-Host "âœ“ CMake configuration successful"

      - name: Build Project
        run: |
          cd build
          
          Write-Host "Building Finix Player..."
          mingw32-make -j$env:NUMBER_OF_PROCESSORS
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Build failed"
            exit 1
          }
          
          Write-Host "âœ“ Build successful"
          
          # Verify executable exists
          if (Test-Path "FinixPlayer.exe") {
            Write-Host "âœ“ FinixPlayer.exe created successfully"
            $size = (Get-Item "FinixPlayer.exe").Length / 1MB
            Write-Host "Executable size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "FinixPlayer.exe not found after build"
            exit 1
          }

      - name: Deploy Qt Dependencies
        run: |
          cd build
          
          Write-Host "Deploying Qt dependencies..."
          
          $windeployqt = "${env:Qt6_DIR}\..\..\..\bin\windeployqt.exe"
          
          if (Test-Path $windeployqt) {
            Write-Host "Using windeployqt: $windeployqt"
            & $windeployqt --qmldir ../. --release FinixPlayer.exe
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ“ Qt dependencies deployed successfully"
            } else {
              Write-Warning "windeployqt returned non-zero exit code, but continuing..."
            }
          } else {
            Write-Error "windeployqt.exe not found at $windeployqt"
            exit 1
          }

      - name: Copy Additional Files
        run: |
          cd build
          
          Write-Host "Copying additional files..."
          
          # Copy yt-dlp
          Copy-Item -Path ../yt-dlp.exe -Destination . -Force
          Write-Host "âœ“ Copied yt-dlp.exe"
          
          # Copy README and LICENSE
          Copy-Item -Path ../README.md -Destination . -Force -ErrorAction SilentlyContinue
          Write-Host "âœ“ Copied README.md"
          
          Copy-Item -Path ../LICENSE -Destination . -Force -ErrorAction SilentlyContinue
          Write-Host "âœ“ Copied LICENSE"
          
          # Copy assets if they exist
          if (Test-Path ../assests) {
            Copy-Item -Path ../assests -Destination . -Recurse -Force
            Write-Host "âœ“ Copied assets directory"
          }

      - name: Create Distribution Package
        run: |
          Write-Host "Creating distribution package..."
          
          $distDir = "FinixPlayer-Windows-x64"
          
          # Create distribution directory
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null
          
          # Copy all necessary files from build directory
          Copy-Item -Path build/FinixPlayer.exe -Destination $distDir/ -Force
          Copy-Item -Path build/yt-dlp.exe -Destination $distDir/ -Force
          
          # Copy DLLs
          Get-ChildItem -Path build -Filter "*.dll" -File | Copy-Item -Destination $distDir/ -Force
          
          # Copy Qt plugins and QML directories
          if (Test-Path build/plugins) {
            Copy-Item -Path build/plugins -Destination $distDir/ -Recurse -Force
          }
          
          if (Test-Path build/qml) {
            Copy-Item -Path build/qml -Destination $distDir/ -Recurse -Force
          }
          
          # Copy documentation
          Copy-Item -Path README.md -Destination $distDir/ -Force -ErrorAction SilentlyContinue
          Copy-Item -Path LICENSE -Destination $distDir/ -Force -ErrorAction SilentlyContinue
          
          # Copy assets
          if (Test-Path assests) {
            Copy-Item -Path assests -Destination $distDir/ -Recurse -Force
          }
          
          Write-Host "âœ“ Distribution files copied"
          
          # List contents
          Write-Host "`nDistribution package contents:"
          Get-ChildItem -Path $distDir -Recurse | Select-Object FullName, Length | Format-Table -AutoSize
          
          # Create ZIP archive
          Write-Host "`nCreating ZIP archive..."
          Compress-Archive -Path $distDir -DestinationPath "$distDir.zip" -Force
          
          if (Test-Path "$distDir.zip") {
            $size = (Get-Item "$distDir.zip").Length / 1MB
            Write-Host "âœ“ ZIP archive created successfully"
            Write-Host "Archive size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "Failed to create ZIP archive"
            exit 1
          }

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FinixPlayer-Windows-x64
          path: FinixPlayer-Windows-x64.zip
          retention-days: 30
          if-no-files-found: error

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  create-github-release:
    name: Create GitHub Release
    needs: build-windows-mingw
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.create_release == 'true' ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: FinixPlayer-Windows-x64
          path: ./release-files

      - name: Generate Release Tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
          else
            TAG_NAME="v1.0.0-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG_NAME"

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸŽµ Finix Player Release
          
          ### Features
          - ðŸŽšï¸ Real-time audio effects (Gain, Balance, Speed, Fade In)
          - ðŸŽ¬ YouTube audio streaming
          - ðŸ“š Smart music library with metadata
          - ðŸŽ¨ Modern dark-themed UI
          - ðŸŽµ Multiple format support (MP3, FLAC, OGG, WAV, M4A, AAC)
          
          ### Installation
          1. Download `FinixPlayer-Windows-x64.zip`
          2. Extract to your desired location
          3. Run `FinixPlayer.exe`
          
          ### Requirements
          - Windows 10/11 (64-bit)
          - No additional dependencies required (all bundled)
          
          ### What's Included
          - FinixPlayer executable
          - yt-dlp for YouTube streaming
          - All required Qt libraries
          
          Built with Qt 6.8.1 and C++17
          EOF
          
          echo "Release notes created"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Finix Player ${{ steps.tag.outputs.tag_name }}
          body_path: release_notes.md
          files: |
            ./release-files/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Build Windows (Simple)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Windows Build
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          modules: 'qtmultimedia qtshadertools qt5compat'
          cache: true
          set-env: true  # Automatically set environment variables

      - name: Download yt-dlp
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "yt-dlp.exe"

      - name: Build with Qt CMake
        shell: pwsh
        run: |
          # Use Qt's qmake to find the right compiler
          $qmake = (Get-Command qmake).Source
          $qtDir = Split-Path (Split-Path $qmake -Parent) -Parent
          $mingwBin = "$qtDir\bin"
          
          Write-Host "Qt Directory: $qtDir"
          Write-Host "Adding to PATH: $mingwBin"
          $env:PATH = "$mingwBin;$env:PATH"
          
          # Verify compiler
          Write-Host "`nCompiler info:"
          gcc --version
          
          # Build
          mkdir build
          cd build
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Deploy Qt
        shell: pwsh
        run: |
          cd build
          windeployqt --qmldir .. --release FinixPlayer.exe

      - name: Package
        shell: pwsh
        run: |
          $dist = "FinixPlayer-Windows"
          New-Item -ItemType Directory -Path $dist
          Copy-Item build/FinixPlayer.exe $dist/
          Copy-Item yt-dlp.exe $dist/
          Copy-Item build/*.dll $dist/ -ErrorAction SilentlyContinue
          Copy-Item build/plugins $dist/ -Recurse -ErrorAction SilentlyContinue
          Copy-Item build/qml $dist/ -Recurse -ErrorAction SilentlyContinue
          Copy-Item README.md $dist/ -ErrorAction SilentlyContinue
          Copy-Item LICENSE $dist/ -ErrorAction SilentlyContinue
          Copy-Item assests $dist/ -Recurse -ErrorAction SilentlyContinue
          Compress-Archive -Path $dist -DestinationPath "${dist}.zip"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FinixPlayer-Windows
          path: FinixPlayer-Windows.zip

name: Build Finix Player for Windows

on:
  push:
    branches: 
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  QT_VERSION: '6.10.0'
  CMAKE_BUILD_TYPE: Release
  BUILD_DIR: build
  ARTIFACT_NAME: FinixPlayer-Windows

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    
    steps:
      # ========================================
      # STEP 1: Checkout Repository
      # ========================================
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ========================================
      # STEP 2: Setup Python for aqtinstall
      # ========================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install aqtinstall
        run: |
          python -m pip install --upgrade pip
          pip install aqtinstall

      # ========================================
      # STEP 3: List Available Modules (for debugging)
      # ========================================
      - name: List Available Qt Modules
        run: |
          Write-Host "Listing available Qt modules for 6.10.0..."
          aqt list-qt windows desktop --modules 6.10.0 win64_mingw
        shell: pwsh
        continue-on-error: true

      # ========================================
      # STEP 4: Install Qt 6.10 Base
      # ========================================
      - name: Install Qt 6.10.0 Base
        run: |
          aqt install-qt windows desktop 6.10.0 win64_mingw -O C:\Qt
        shell: cmd

      # ========================================
      # STEP 5: Install Qt Modules
      # ========================================
      - name: Install Qt Multimedia Module
        run: |
          aqt install-qt windows desktop 6.10.0 win64_mingw -m qtmultimedia -O C:\Qt
        shell: cmd
        continue-on-error: true

      - name: Install Qt 5 Compat Module
        run: |
          aqt install-qt windows desktop 6.10.0 win64_mingw -m qt5compat -O C:\Qt
        shell: cmd
        continue-on-error: true

      - name: Install Qt Shader Tools Module
        run: |
          aqt install-qt windows desktop 6.10.0 win64_mingw -m qtshadertools -O C:\Qt
        shell: cmd
        continue-on-error: true

      # ========================================
      # STEP 6: Install MinGW Toolchain
      # ========================================
      - name: Install MinGW 13.1.0
        run: |
          aqt install-tool windows desktop tools_mingw1310 -O C:\Qt
        shell: cmd

      # ========================================
      # STEP 7: Setup Environment Variables
      # ========================================
      - name: Set Qt Environment
        run: |
          echo "C:\Qt\6.10.0\mingw_64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Qt\Tools\mingw1310_64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "CMAKE_PREFIX_PATH=C:\Qt\6.10.0\mingw_64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      # ========================================
      # STEP 8: Verify Installation
      # ========================================
      - name: Verify Qt and MinGW
        run: |
          Write-Host "Checking Qt installation..."
          qmake --version
          Write-Host "`nChecking MinGW installation..."
          gcc --version
          g++ --version
          Write-Host "`nChecking CMake..."
          cmake --version
          Write-Host "`nChecking Qt CMake files..."
          if (Test-Path "C:\Qt\6.10.0\mingw_64\lib\cmake\Qt6") {
            Write-Host "Qt6 CMake files found"
            Get-ChildItem "C:\Qt\6.10.0\mingw_64\lib\cmake" -Directory | Select-Object Name
          }
        shell: pwsh

      # ========================================
      # STEP 9: Download yt-dlp
      # ========================================
      - name: Download yt-dlp
        run: |
          Write-Host "Downloading yt-dlp.exe..."
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "yt-dlp.exe"
          Write-Host "yt-dlp.exe downloaded successfully"
        shell: pwsh
        continue-on-error: true

      # ========================================
      # STEP 7: Configure CMake
      # ========================================
      - name: Configure CMake
        run: |
          cmake -S . -B ${{ env.BUILD_DIR }} -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} -DCMAKE_PREFIX_PATH=C:\Qt\6.10.0\mingw_64
        shell: cmd

      # ========================================
      # STEP 8: Build Project
      # ========================================
      - name: Build Project
        run: |
          cmake --build ${{ env.BUILD_DIR }} --config ${{ env.CMAKE_BUILD_TYPE }} --parallel 4
        shell: cmd

      # ========================================
      # STEP 9: Deploy Qt Dependencies
      # ========================================
      - name: Deploy Qt Runtime
        run: |
          windeployqt --qmldir . --release ${{ env.BUILD_DIR }}\FinixPlayer.exe
        shell: cmd

      # ========================================
      # STEP 13: Copy Additional Files
      # ========================================
      - name: Prepare Portable Package
        run: |
          Write-Host "Copying yt-dlp.exe..."
          if (Test-Path "yt-dlp.exe") {
            Copy-Item "yt-dlp.exe" "${{ env.BUILD_DIR }}\" -Force
          }
          
          Write-Host "Copying README.md..."
          if (Test-Path "README.md") {
            Copy-Item "README.md" "${{ env.BUILD_DIR }}\" -Force
          }
          
          Write-Host "Copying LICENSE..."
          if (Test-Path "LICENSE") {
            Copy-Item "LICENSE" "${{ env.BUILD_DIR }}\" -Force
          }
          
          Write-Host "Creating build info file..."
          $buildInfo = @"
          Finix Player - Windows Build
          =============================
          Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          Qt Version: ${{ env.QT_VERSION }}
          Build Type: ${{ env.CMAKE_BUILD_TYPE }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          
          System Requirements:
          - Windows 10 or later (64-bit)
          - No installation required
          
          How to Run:
          1. Extract all files to a folder
          2. Double-click FinixPlayer.exe
          3. Enjoy your music!
          "@
          $buildInfo | Out-File -FilePath "${{ env.BUILD_DIR }}\BUILD_INFO.txt" -Encoding utf8
          
          Write-Host "`nPackage contents:"
          Get-ChildItem "${{ env.BUILD_DIR }}" | Select-Object Name, Length | Format-Table
        shell: pwsh

      # ========================================
      # STEP 14: Upload Artifacts
      # ========================================
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.run_number }}
          path: ${{ env.BUILD_DIR }}/**
          retention-days: 30

      # ========================================
      # STEP 15: Build Summary
      # ========================================
      - name: Display Build Summary
        if: success()
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "          BUILD SUCCESSFUL"
          Write-Host "=========================================="
          Write-Host "Project: Finix Player"
          Write-Host "Qt Version: ${{ env.QT_VERSION }}"
          Write-Host "Build Type: ${{ env.CMAKE_BUILD_TYPE }}"
          Write-Host "Commit: ${{ github.sha }}"
          Write-Host "=========================================="
          
          $exePath = "${{ env.BUILD_DIR }}\FinixPlayer.exe"
          if (Test-Path $exePath) {
            $exeSize = (Get-Item $exePath).Length / 1MB
            Write-Host "Executable Size: $($exeSize.ToString('0.00')) MB"
          }
          
          $totalSize = (Get-ChildItem "${{ env.BUILD_DIR }}" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Total Package Size: $($totalSize.ToString('0.00')) MB"
          Write-Host "=========================================="
        shell: pwsh

      # ========================================
      # STEP 16: Upload Logs on Failure
      # ========================================
      - name: Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            ${{ env.BUILD_DIR }}/CMakeFiles/*.log
            ${{ env.BUILD_DIR }}/**/*.log
          retention-days: 7
          if-no-files-found: ignore
